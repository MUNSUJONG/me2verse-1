<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<title>Me2Verse â€” ê°ì„±í˜• ìŠ¤í† ë¦¬ / ì‚¬ìš©ìì œì•ˆ ë°˜ì˜ ë°ëª¨</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root{--bg:#f7f8fc;--card:#fff;--muted:#6b7280;--brand:#6C5CE7;--ok:#16a34a}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif;background:var(--bg);color:#111}
  .app{max-width:1100px;margin:20px auto;padding:16px}
  .flags{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .flags img{width:88px}
  .hud{position:fixed;left:50%;transform:translateX(-50%);top:10px;background:rgba(255,255,255,0.9);padding:8px 12px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.08);z-index:50}
  .score{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;background:rgba(0,0,0,.7);color:#fff;padding:8px 12px;border-radius:10px;z-index:50}
  .row{display:flex;gap:12px;flex-wrap:wrap}
  .card{background:var(--card);border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.04)}
  input,select,textarea,button{font-size:15px;padding:10px;border-radius:8px;border:1px solid #e6e9f2}
  button{background:var(--brand);color:#fff;border:none;cursor:pointer}
  .ghost{background:transparent;border:1px solid #e6e9f2;color:var(--muted)}
  .modules{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-top:12px}
  .story{display:flex;flex-direction:column;gap:8px;border-radius:10px;overflow:hidden}
  .thumb{height:120px;background:#e6e9ff;background-size:cover;background-position:center;display:flex;align-items:flex-start;justify-content:flex-end;padding:10px}
  .tag{background:rgba(255,255,255,.9);padding:6px 8px;border-radius:999px;font-weight:700;color:var(--brand)}
  .chips{display:flex;gap:6px;flex-wrap:wrap}
  .chip{background:#f1f5f9;padding:6px 8px;border-radius:999px;font-size:13px;color:var(--muted)}
  .play-area{margin-top:12px}
  .step{margin-bottom:10px}
  .quest-log{position:fixed;right:12px;bottom:84px;width:320px;max-height:50vh;overflow:auto;z-index:45}
  .submission-form{display:grid;gap:8px}
  .admin-panel{position:fixed;left:12px;top:12px;width:320px;max-height:80vh;overflow:auto;z-index:60}
  .small{font-size:13px;color:var(--muted)}
  .pill{padding:6px 8px;border-radius:999px;background:#eef2ff;color:var(--brand);font-weight:700}
</style>
</head>
<body>
  <div class="hud card" id="status">ìƒíƒœ: ëŒ€ê¸° ì¤‘</div>
  <div class="score card" id="score">í¬ì¸íŠ¸: <b id="scorePts">0</b> | ì•„ì´í…œ: <span id="scoreItems">ì—†ìŒ</span> | ê²°ì œ: Ï€ (Pi)</div>

  <div class="app">
    <div class="flags">
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_South_Korea.svg" alt="íƒœê·¹ê¸° L">
      <div style="text-align:center">
        <h1 style="margin:0">Me2Verse â€” ê°ì„±í˜• ì œ2ì˜ ì‚¶</h1>
        <div class="small">ê¸°ì˜ê³  ì¦ê²ê³  í¥ë¶„ë˜ëŠ” ìŠ¤í† ë¦¬, í˜¸ê¸°ì‹¬ì´ ì§€ì†ë˜ëŠ” ê²½í—˜ì„ ì§€í–¥í•©ë‹ˆë‹¤</div>
      </div>
      <img src="https://upload.wikimedia.org/wikipedia/commons/0/09/Flag_of_South_Korea.svg" alt="íƒœê·¹ê¸° R">
    </div>

    <!-- ë¡œê·¸ì¸/ê²°ì œ (ë³€ê²½ê¸ˆì§€) -->
    <div class="card row" style="align-items:center">
      <input id="username" placeholder="ìœ ì € ì´ë¦„ ì…ë ¥" />
      <select id="amount">
        <option value="1">1 Pi</option><option value="5">5 Pi</option><option value="10">10 Pi</option>
      </select>
      <button id="autoBtn">ìë™ ë¡œê·¸ì¸ + Pi ê²°ì œ</button>
      <div style="margin-left:auto" class="small">ë¬´ë£Œì²´í—˜(ì¼ë¶€) Â· í•˜ì´ë¼ì´íŠ¸ ì²´í—˜ì€ Pi ê²°ì œë¡œ ì ê¸ˆí•´ì œ</div>
    </div>

    <!-- ê²€ìƒ‰/í•„í„° -->
    <div style="margin-top:12px" class="row">
      <input id="search" placeholder="ìŠ¤í† ë¦¬ ê²€ìƒ‰ Â· ê°ì • íƒœê·¸ë¡œë„ í•„í„°(ì˜ˆ: ë”°ëœ»í•¨, ì„¤ë ˜)" style="flex:1" />
      <select id="filter">
        <option value="all">ëª¨ë‘</option><option value="free">ë¬´ë£Œ</option><option value="paid">í•˜ì´ë¼ì´íŠ¸(ìœ ë£Œ)</option>
      </select>
      <select id="sort">
        <option value="recommend">ì¶”ì²œ</option><option value="new">ìµœì‹ </option><option value="hot">ì¸ê¸°</option>
      </select>
      <button id="myRecords" class="ghost">ë‚´ ì²´í—˜ ê¸°ë¡ ë³´ê¸°</button>
    </div>

    <!-- ëª¨ë“ˆ ìŠ¤í† ë¦¬ ê·¸ë¦¬ë“œ -->
    <div id="modulesWrap" style="margin-top:12px" class="card">
      <h3 style="margin:6px 0">ìŠ¤í† ë¦¬ ì›”ë“œ â€” ëª¨ë“ˆë³„ ê°ì„±í˜• ì²´í—˜</h3>
      <div class="modules" id="storiesGrid"></div>
    </div>

    <!-- í”Œë ˆì´ ì˜ì—­ -->
    <div id="playWrap" class="card" style="margin-top:12px;display:none">
      <div class="row" style="align-items:center">
        <h3 id="playTitle" style="margin:4px 0"></h3>
        <div style="margin-left:auto" id="playMeta" class="small"></div>
      </div>
      <div id="playThumb" class="thumb" style="margin-top:6px"><div id="playTag" class="tag">STORY</div></div>
      <p id="playDesc" class="small"></p>
      <div id="stepsArea" class="play-area"></div>
      <div style="margin-top:10px" class="row">
        <button id="btnComplete" class="ghost">ì™„ë£Œ ì²˜ë¦¬ (ë³´ìƒ ì§€ê¸‰)</button>
        <button id="btnBack" class="ghost">ëª©ë¡ìœ¼ë¡œ</button>
      </div>
    </div>

    <!-- ì œì¶œ í¼ -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 8px">ìŠ¤í† ë¦¬ ì œì•ˆí•˜ê¸° (ì‚¬ìš©ì ì œì¶œ)</h3>
      <form id="submission" class="submission-form">
        <input id="subTitle" placeholder="ìŠ¤í† ë¦¬ ì œëª© (ì˜ˆ: ë¹„ì˜¤ëŠ” ë‚ ì˜ ì•½ì†)" required />
        <textarea id="subSynopsis" placeholder="í•œì¤„ ì‹œë†‰ì‹œìŠ¤(ê°ì„± ì¤‘ì‹¬)" rows="2"></textarea>
        <input id="subTags" placeholder="ê°ì • íƒœê·¸(ì‰¼í‘œë¡œ êµ¬ë¶„, ì˜ˆ: ë”°ëœ»í•¨,ì„¤ë ˜)" />
        <select id="subPremium"><option value="false">ë¬´ë£Œ</option><option value="true">í•˜ì´ë¼ì´íŠ¸(ìœ ë£Œ)</option></select>
        <div class="row">
          <button type="submit">ì œì¶œ</button>
          <div class="small" style="margin-left:auto">ì œì•ˆì€ ê´€ë¦¬ì ê²€í†  í›„ ë°˜ì˜ë©ë‹ˆë‹¤</div>
        </div>
      </form>
    </div>

    <!-- ê´€ë¦¬ì íŒ¨ë„ (ë°ëª¨ìš©, ë¡œì»¬ì—ì„œ ì—´ëŒ/ìˆ˜ë½ ê°€ëŠ¥) -->
    <div class="admin-panel card">
      <h4 style="margin:0 0 8px">ê´€ë¦¬ì ê²€í† (ë°ëª¨)</h4>
      <div id="submissionsList"></div>
      <hr/>
      <div class="small">ê´€ë¦¬ì ë„êµ¬: ì œì¶œì„ ìˆ˜ë½í•˜ë©´ ë¼ì´ë¸Œ DB(í”„ë¡ íŠ¸ ì—”ë“œ)ì— ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤.</div>
    </div>

    <!-- í€˜ìŠ¤íŠ¸ ë¡œê·¸ -->
    <div id="questLog" class="quest-log"></div>

  </div>

<script>
/* ===== ì´ˆê¸° ë°ì´í„°: ê°ì„± ìŠ¤í† ë¦¬ ì„¸íŠ¸ (ëª¨ë“ˆë³„ 10ê°œì”© ì¼ë¶€ ì¶•ì•½ ë²„ì „ í¬í•¨ - ì „ì²´ëŠ” êµ¬ì¡°ëŒ€ë¡œ í™•ì¥ ê°€ëŠ¥) ===== */
const modulesStories = {
  romance: [
    { id:'romance_01', title:'ì²«ëˆˆì˜ ì¬íšŒ', desc:'ê²¨ìš¸, ì²«ëˆˆ ë‚´ë¦¬ë˜ ë‚  ìš°ì—°íˆ ë§ˆì£¼ì¹œ ì˜›ì‚¬ë‘ê³¼ì˜ ìˆœê°„.', tags:['nostalgic','warm'], diff:'ë³´í†µ', time:8, isPremium:false, reward:{points:8,items:['í´ë¼ë¡œì´ë“œ']},
      steps:[
        {title:'ì¸ì‚¬í•˜ê¸°', a:'ë¯¸ì†Œë¡œ ë‹¤ê°€ê°„ë‹¤', b:'ë¨¼ì € ë§ ê±¸ê¸° ì–´ë µë‹¤', aMsg:'ìƒëŒ€ê°€ ë°˜ê°‘ê²Œ ì›ƒìŠµë‹ˆë‹¤. ì¹œë°€ë„ +5', bMsg:'ì¡°ê¸ˆ ì–´ìƒ‰í•˜ì§€ë§Œ ê¸°íšŒëŠ” ë‚¨ì•˜ìŠµë‹ˆë‹¤. ì¹œë°€ë„ +1', tag:'ë”°ëœ»í•¨'},
        {title:'ì¹´í˜ ì´ˆëŒ€', a:'ì¦‰ì‹œ ì´ˆëŒ€í•œë‹¤', b:'ë‚˜ì¤‘ì— ë³´ìê³  í•œë‹¤', aMsg:'ëŒ€í™”ê°€ ê¸¸ì–´ì§€ê³  ê³µê°ì´ ìŒ“ì…ë‹ˆë‹¤. +7', bMsg:'ë‹¤ìŒ ë§Œë‚¨ ê¸°íšŒê°€ ì¤„ì–´ë“­ë‹ˆë‹¤. +0', tag:'í¬ë§'},
        {title:'ë§ˆë¬´ë¦¬', a:'ë‹¤ìŒ ì•½ì†ì„ ì¡ëŠ”ë‹¤', b:'ì—°ë½ì²˜ë§Œ êµí™˜', aMsg:'ê´€ê³„ê°€ í™•ì¥ë©ë‹ˆë‹¤. íŠ¹ë³„ ì¥ë©´ ì ê¸ˆ', bMsg:'ê¸°ë³¸ ìœ ì§€', tag:'ì„¤ë ˜'}
      ]
    },
    /* ... romance_02 .. romance_10 (omitted for brevity in demo) */
  ],
  space: [
    { id:'space_01', title:'ë‹¬ ì°©ë¥™ì˜ ìƒˆë²½', desc:'ë‹¬ í‘œë©´ì— ì²« ë°œì„ ë‚´ë”›ëŠ” ìˆœê°„ì˜ ë²…ì°¸.', tags:['awe','thrill'], diff:'ë³´í†µ', time:9, isPremium:true, reward:{points:20,items:['ì›”ì„']},
      steps:[
        {title:'ì°©ë¥™ ê°ë„ ì¡°ì •', a:'ì •í™•íˆ ì¡°ì •í•œë‹¤', b:'ë³´ìˆ˜ì ìœ¼ë¡œ ì ‘ê·¼', aMsg:'ì„±ê³µì ìœ¼ë¡œ ì°©ë¥™! +10', bMsg:'ì°©ë¥™ ì¤‘ í”ë“¤ë ¸ìœ¼ë‚˜ ì•ˆì „í•¨ +3', tag:'í¥ë¶„'},
        {title:'ë„ì–´ ì˜¤í”ˆ', a:'ì‹ ì¤‘íˆ ì˜¤í”ˆ', b:'í•œ ë²ˆì— ë¹ ë¥´ê²Œ', aMsg:'ë‹¬ì˜ ëƒ„ìƒˆë¥¼ ë§¡ëŠ” ë“¯í•œ ê°ë™ +8', bMsg:'ê¸´ì¥ê° ìˆì§€ë§Œ ìƒìƒí•œ ì²´í—˜ +6', tag:'ê²½ì´'}
      ]
    },
    /* ... other space stories ... */
  ],
  hobby: [
    { id:'hobby_01', title:'ìˆ²ì†ì˜ ì•„ì¹¨', desc:'ìƒˆë²½ ìˆ²ì—ì„œ ê³ ìš”í•¨ì„ ëŠë¼ë©° ë§ˆìŒì„ ê³ ìš”íˆ í•˜ëŠ” ì‹œê°„', tags:['calm','healing'], diff:'ì‰¬ì›€', time:6, isPremium:false, reward:{points:6,items:['ìì‚¬ê·€']},
      steps:[
        {title:'ìˆ²ê¸¸ ê±·ê¸°', a:'ì²œì²œíˆ í˜¸í¡í•œë‹¤', b:'ë¹ ë¥´ê²Œ ê±·ëŠ”ë‹¤', aMsg:'ë§ˆìŒì´ ì”ì”í•´ì§‘ë‹ˆë‹¤. +3', bMsg:'ì—ë„ˆì§€ê°€ ìƒìŠ¹í•©ë‹ˆë‹¤. +2', tag:'íë§'}
      ]
    },
    /* ... */
  ],
  entertain: [
    /* ... */
  ],
  city: [
    /* ... */
  ]
};

/* ===== ìœ í‹¸ / ìƒíƒœ ì €ì¥ (localStorage ê¸°ë°˜ ë°ëª¨) ===== */
const STORE_KEYS = { EXPERIENCES:'mv_experiences_v1', SUBMISSIONS:'mv_submissions_v1', PROGRESS:'mv_progress_v1' };
let state = { user:null, points:0, items:[], experiences: load(STORE_KEYS.EXPERIENCES, []), submissions: load(STORE_KEYS.SUBMISSIONS, []), progress: load(STORE_KEYS.PROGRESS, {}) };

function load(k,def){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):def; }catch(e){return def;} }
function save(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

/* ===== UI ìš”ì†Œ ì°¸ì¡° ===== */
const statusEl = document.getElementById('status');
const scorePts = document.getElementById('scorePts');
const scoreItems = document.getElementById('scoreItems');
const storiesGrid = document.getElementById('storiesGrid');
const searchEl = document.getElementById('search');
const filterEl = document.getElementById('filter');
const sortEl = document.getElementById('sort');
const autoBtn = document.getElementById('autoBtn');
const usernameEl = document.getElementById('username');
const amountEl = document.getElementById('amount');
const playWrap = document.getElementById('playWrap');
const playTitle = document.getElementById('playTitle');
const playThumb = document.getElementById('playThumb');
const playDesc = document.getElementById('playDesc');
const stepsArea = document.getElementById('stepsArea');
const btnBack = document.getElementById('btnBack');
const btnComplete = document.getElementById('btnComplete');
const submissionsList = document.getElementById('submissionsList');
const submissionForm = document.getElementById('submission');
const myRecordsBtn = document.getElementById('myRecords');

/* ===== ì´ˆê¸° ë Œë” & í—¬í¼ ===== */
function setStatus(msg){ statusEl.textContent = msg; }
function hudUpdate(){ scorePts.textContent = state.points; scoreItems.textContent = state.items.length? state.items.join(', '): 'ì—†ìŒ'; }
function toast(msg){ const t=document.createElement('div'); t.className='card'; t.style.marginBottom='8px'; t.textContent=msg; document.getElementById('appToast')?.remove(); document.body.insertAdjacentHTML('beforeend',`<div id="appToast" style="position:fixed;right:12px;top:12px;z-index:9999"></div>`); document.getElementById('appToast').appendChild(t); setTimeout(()=>t.remove(),2400); }

function renderAll(){
  // flatten module stories into array with module key
  let arr=[]; for(const mk in modulesStories){ modulesStories[mk].forEach(s=> arr.push(Object.assign({},s,{module:mk}))) }
  // filter
  const q=searchEl.value.trim().toLowerCase();
  if(q) arr = arr.filter(s=> s.title.toLowerCase().includes(q) || s.desc.toLowerCase().includes(q) || (s.tags && s.tags.join(' ').includes(q)));
  if(filterEl.value==='free') arr = arr.filter(s=> !s.isPremium);
  if(filterEl.value==='paid') arr = arr.filter(s=> s.isPremium);
  // TODO: sort logic
  // clear
  storiesGrid.innerHTML='';
  arr.forEach(story => {
    const div = document.createElement('div'); div.className='card story';
    div.innerHTML = `<div class="thumb" style="background-image:url('${story.thumb||('https://picsum.photos/seed/'+encodeURIComponent(story.title)+'/800/450')}')">
        <div class="tag">${story.isPremium? 'HIGHLIGHT (Ï€)' : 'FREE'}</div></div>
      <div style="padding:8px 6px"><b>${story.title}</b><div class="small muted">${story.desc}</div>
      <div class="chips" style="margin-top:8px">
        <div class="chip">ë‚œì´ë„:${story.diff||'ë³´í†µ'}</div>
        <div class="chip">ì†Œìš”:${story.time||8}ë¶„</div>
        <div class="chip">ê°ì •:${(story.tags||[]).join(', ')}</div>
      </div>
      <div class="row" style="margin-top:8px">
        <button data-play="${story.id}">ì‹œì‘</button>
        <button class="ghost" data-like="${story.id}">ì°œ</button>
      </div></div>`;
    storiesGrid.appendChild(div);
    div.querySelector('[data-play]').addEventListener('click', ()=> tryOpenStory(story));
    div.querySelector('[data-like]').addEventListener('click', ()=> { toast('ì°œ ë“±ë¡ (ë°ëª¨)'); });
  });
}

/* ===== ë¡œê·¸ì¸ + Pi ê²°ì œ(ì‹œë®¬ë ˆì´ì…˜) â€” ê¸°ì¡´ ë¡œì§ ìœ ì§€ ===== */
autoBtn.addEventListener('click', ()=>{
  const user = usernameEl.value.trim(), amount = amountEl.value;
  if(!user){ alert('ìœ ì € ì´ë¦„ ì…ë ¥ í•„ìš”!'); return; }
  setStatus(`ìƒíƒœ: ${user} ë¡œê·¸ì¸ ì¤‘...`);
  setTimeout(()=> {
    setStatus(`ìƒíƒœ: ${user} ë¡œê·¸ì¸ ì„±ê³µ! ğŸ‰`);
    setStatus(`ìƒíƒœ: ${amount} Pi ê²°ì œ ì²˜ë¦¬ ì¤‘...`);
    setTimeout(()=>{
      setStatus(`ìƒíƒœ: ${user} ê²°ì œ ì™„ë£Œ! ğŸ’°`);
      alert(`${user}ë‹˜ì˜ ${amount} Pi ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!`);
      state.user = user;
      // welcome reward (demo)
      state.points += 5 * Number(amount);
      hudUpdate();
      renderAll();
      renderSubmissions();
    },1200);
  },800);
});

/* ===== ìŠ¤í† ë¦¬ ì—´ê¸° â€” ìœ ë£Œì¼ ê²½ìš° ê²°ì œ ìœ ë„ (ì‹œë®¬ë ˆì´ì…˜) ===== */
function tryOpenStory(story){
  if(story.isPremium){
    if(!state.user){ alert('í•˜ì´ë¼ì´íŠ¸ ì²´í—˜ì€ ë¡œê·¸ì¸ ë° Pi ê²°ì œê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
    const ok = confirm(`"${story.title}"ì€ í•˜ì´ë¼ì´íŠ¸(ìœ ë£Œ)ì…ë‹ˆë‹¤. ${story.reward?.points||10} í¬ì¸íŠ¸ + ê¸°ë… ì•„ì´í…œ(ìœ ë£Œ)ì„ íšë“í•©ë‹ˆë‹¤.\nê²°ì œ: ${prompt('ê²°ì œ ìˆ˜ëŸ‰ Ï€ ì…ë ¥ (ì˜ˆ: 1)') || 'ì·¨ì†Œ'}`);
    if(!ok){ return; }
    // simulate payment success
  }
  openStory(story);
}

/* ===== ì˜¤í”ˆ ìŠ¤í† ë¦¬: í”Œë ˆì´ UI êµ¬ì„± ===== */
let currentStory = null;
function openStory(story){
  currentStory = story;
  playWrap.style.display = 'block';
  playTitle.textContent = story.title + ' Â· ' + (story.module||'');
  playDesc.textContent = story.desc;
  document.getElementById('playTag').textContent = story.isPremium? 'HIGHLIGHT':'STORY';
  playThumb.style.backgroundImage = `url('${story.thumb||('https://picsum.photos/seed/'+encodeURIComponent(story.title)+'/800/450')}')`;
  stepsArea.innerHTML = '';
  story.steps.forEach((st, idx)=>{
    const box = document.createElement('div'); box.className='card step';
    box.innerHTML = `<b>${idx+1}. ${st.title}</b>
      <div class="row" style="margin-top:8px">
        <button data-a>${st.a}</button>
        <button class="ghost" data-b>${st.b}</button>
      </div>
      <p class="small" data-msg style="min-height:18px;margin-top:6px"></p>`;
    const btnA = box.querySelector('[data-a]'), btnB = box.querySelector('[data-b]'), msg = box.querySelector('[data-msg]');
    btnA.addEventListener('click', ()=> { msg.textContent = st.aMsg; addRewardForChoice(st.aMsg, st.tag); btnA.disabled = true; btnB.disabled = true; });
    btnB.addEventListener('click', ()=> { msg.textContent = st.bMsg; addRewardForChoice(st.bMsg, st.tag); btnA.disabled = true; btnB.disabled = true; });
    stepsArea.appendChild(box);
  });
}

/* ë³´ìƒ ì²˜ë¦¬ (ì„ íƒì‹œ ì†Œì†Œí•œ ë³´ìƒ) */
function addRewardForChoice(msg, tag){
  // small reward logic: textual parsing for +N
  const m = (msg||'').match(/\+(\d+)/);
  let pts = m ? Number(m[1]) : 2;
  state.points += pts;
  // item heuristic
  if(msg.includes('í•˜íŠ¸')) state.items.push('í•˜íŠ¸');
  hudUpdate();
  logQuest(msg);
}

/* í€˜ìŠ¤íŠ¸ ë¡œê·¸ ì¶”ê°€ */
function logQuest(txt){
  const el = document.createElement('div'); el.className='card'; el.style.marginBottom='8px'; el.innerHTML = `<b>í€˜ìŠ¤íŠ¸:</b> ${txt}`; document.getElementById('questLog').prepend(el);
}

/* ì™„ë£Œ ì²˜ë¦¬ */
btnComplete.addEventListener('click', ()=>{
  if(!currentStory) return;
  // record experience
  const exp = { id: 'exp_'+Date.now(), user: state.user||'guest', storyId: currentStory.id, title: currentStory.title, timestamp: new Date().toISOString(), points: currentStory.reward?.points||10, items: currentStory.reward?.items||[] };
  state.experiences.unshift(exp); save(STORE_KEYS.EXPERIENCES, state.experiences);
  state.points += exp.points; state.items.push(...exp.items);
  hudUpdate(); logQuest(`ìŠ¤í† ë¦¬ ì™„ë£Œ: ${currentStory.title} Â· +${exp.points}p Â· ì•„ì´í…œ:${exp.items.join(',')}`);
  alert('ìŠ¤í† ë¦¬ ì™„ë£Œ! ë³´ìƒì´ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.');
  // mark progress
  state.progress[currentStory.id] = true; save(STORE_KEYS.PROGRESS, state.progress);
  renderAll();
  // close play
  document.getElementById('playWrap').style.display='none';
  currentStory = null;
});

/* ë’¤ë¡œê°€ê¸° */
btnBack.addEventListener('click', ()=> { document.getElementById('playWrap').style.display='none'; currentStory=null; });

/* ì œì¶œ í¼ */
submissionForm.addEventListener('submit', (ev)=>{
  ev.preventDefault();
  const t = document.getElementById('subTitle').value.trim();
  const s = document.getElementById('subSynopsis').value.trim();
  const tags = document.getElementById('subTags').value.split(',').map(x=>x.trim()).filter(Boolean);
  const isPremium = document.getElementById('subPremium').value === 'true';
  if(!t||!s){ alert('ì œëª©ê³¼ ì‹œë†‰ì‹œìŠ¤ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤'); return; }
  const sub = { id:'sub_'+Date.now(), title:t, synopsis:s, tags, isPremium, status:'pending', submittedAt:new Date().toISOString() };
  state.submissions.unshift(sub); save(STORE_KEYS.SUBMISSIONS, state.submissions);
  renderSubmissions();
  alert('ìŠ¤í† ë¦¬ ì œì•ˆì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê´€ë¦¬ì ê²€í†  í›„ ë°˜ì˜ë©ë‹ˆë‹¤.');
  submissionForm.reset();
});

/* ê´€ë¦¬ íŒ¨ë„ ë Œë” */
function renderSubmissions(){
  submissionsList.innerHTML = '';
  if(!state.submissions.length){ submissionsList.innerHTML = '<div class="small">ê²€í† í•  ì œì¶œ ì—†ìŒ</div>'; return; }
  state.submissions.forEach(sub=>{
    const d = document.createElement('div'); d.className='card'; d.style.marginBottom='8px';
    d.innerHTML = `<b>${sub.title}</b><div class="small">${sub.synopsis}</div><div class="small">íƒœê·¸:${sub.tags.join(', ')}</div><div style="margin-top:8px" class="row">
      <button data-accept="${sub.id}">ìˆ˜ë½</button><button class="ghost" data-reject="${sub.id}">ê±°ì ˆ</button>
    </div>`;
    submissionsList.appendChild(d);
    d.querySelector('[data-accept]').addEventListener('click', ()=> acceptSubmission(sub.id));
    d.querySelector('[data-reject]').addEventListener('click', ()=> rejectSubmission(sub.id));
  });
}

function acceptSubmission(id){
  const idx = state.submissions.findIndex(s=>s.id===id); if(idx<0) return;
  const sub = state.submissions.splice(idx,1)[0];
  // transform into story minimal shape and add to modulesStories['romance'] by default (or ask tag logic)
  const story = { id:'user_'+Date.now(), title:sub.title, desc:sub.synopsis, tags:sub.tags, diff:'ë³´í†µ', time:7, isPremium:sub.isPremium, reward:{points:8, items:['ì œì•ˆ ë³´ìƒ']}, steps:[{title:'ì‹œì‘', a:'ì§„í–‰', b:'ë³´ë¥˜', aMsg:'+5', bMsg:'+1'}] };
  // Decide module by tag inference: if tags include 'space'->space else romance default
  let moduleKey = 'romance';
  if(sub.tags.map(t=>t.toLowerCase()).includes('space')) moduleKey='space';
  if(!modulesStories[moduleKey]) moduleKey='romance';
  modulesStories[moduleKey].unshift(story);
  save(STORE_KEYS.SUBMISSIONS, state.submissions);
  renderSubmissions(); renderAll();
  alert('ì œì•ˆì„ ìˆ˜ë½í•˜ì—¬ ë¼ì´ë¸Œ ìŠ¤í† ë¦¬ì— ë°˜ì˜í–ˆìŠµë‹ˆë‹¤.');
}

function rejectSubmission(id){
  const idx = state.submissions.findIndex(s=>s.id===id); if(idx<0) return;
  const sub = state.submissions[idx];
  if(!confirm(`ì œì•ˆ "${sub.title}"ì„(ë¥¼) ê±°ì ˆí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
  state.submissions.splice(idx,1); save(STORE_KEYS.SUBMISSIONS, state.submissions);
  renderSubmissions(); alert('ì œì•ˆ ê±°ì ˆ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
}

/* ë‚´ ê¸°ë¡ ì—´ê¸° */
myRecordsBtn.addEventListener('click', ()=>{
  const ex = state.experiences;
  if(!ex.length){ alert('ì•„ì§ ì²´í—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
  let msg = 'ë‚´ ì²´í—˜ ê¸°ë¡:\\n\\n';
  ex.slice(0,20).forEach(e=> msg += `${e.title} â€” ${new Date(e.timestamp).toLocaleString()} â€” +${e.points}p\\n`);
  alert(msg);
});

/* init */
function init(){
  // prepare thumbnail fallback for stories lacking thumb
  for(const mk in modulesStories){ modulesStories[mk].forEach(s => { if(!s.thumb) s.thumb = 'https://picsum.photos/seed/'+encodeURIComponent(s.title)+'/800/450'; }) }
  renderAll(); renderSubmissions(); hudUpdate();
}
init();

/* ë³´ì¡°: ì €ì¥ í›… (ì„œë²„ë¡œ ë°”ê¿€ ìˆ˜ ìˆìŒ) */
function saveExperience(exp){
  state.experiences.unshift(exp); save(STORE_KEYS.EXPERIENCES, state.experiences);
}
function saveSubmission(sub){ state.submissions.unshift(sub); save(STORE_KEYS.SUBMISSIONS, state.submissions); }

</script>
</body>
</html>
